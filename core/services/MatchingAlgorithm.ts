// Core matching logic across all phases